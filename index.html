<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Library Open Submissions Collection</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        h1 {
            color: #222;
        }
        .search-section {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .search-container {
            margin-bottom: 15px;
        }
        input[type="text"] {
            padding: 10px;
            width: 100%;
            max-width: 600px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        .filter-group {
            min-width: 200px;
        }
        .filter-heading {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .filter-tag {
            display: inline-block;
            background: #f0f0f0;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .filter-tag:hover {
            background: #e0e0e0;
        }
        .filter-tag.active {
            background: #4a135a;
            color: white;
        }
        .submission {
            background: white;
            border: 1px solid #ddd;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .submission h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.6em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        .meta-group {
            margin-bottom: 5px;
        }
        .meta-label {
            font-weight: bold;
            color: #555;
        }
        .tag {
            display: inline-block;
            background: #e9e9e9;
            padding: 3px 10px;
            border-radius: 15px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .character-tag {
            background-color: #e1f5fe;
        }
        .setting-tag {
            background-color: #e8f5e9;
        }
        .content {
            line-height: 1.7;
            white-space: pre-wrap;
        }
        #loading {
            text-align: center;
            padding: 30px;
            font-style: italic;
            color: #666;
        }
        .links {
            margin-top: 10px;
        }
        .links a {
            color: #4a135a;
            text-decoration: none;
        }
        .links a:hover {
            text-decoration: underline;
        }
        @media (max-width: 768px) {
            .submission {
                padding: 15px;
            }
            .meta {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Black Library Open Submissions Collection</h1>
        <p>A community collection of stories submitted for the Black Library open submissions window.</p>
        <div style="margin-top: 10px; font-size: 0.9em;">
            <p><strong>Having issues?</strong> Make sure your Google Sheet is <a href="https://support.google.com/docs/answer/183965" target="_blank">published to the web</a> (File > Share > Publish to web).</p>
        </div>
    </header>
    
    <div class="search-section">
        <div class="search-container">
            <label for="search">Search submissions:</label>
            <input type="text" id="search" placeholder="Search by title, author, character, content...">
        </div>
        
        <div class="filter-section">
            <div class="filter-group">
                <div class="filter-heading">Filter by setting:</div>
                <div class="filter-tags" id="setting-filters">
                    <!-- Settings will be added here dynamically -->
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-heading">Filter by character:</div>
                <div class="filter-tags" id="character-filters">
                    <!-- Characters will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <div id="loading">Loading submissions...</div>
    <div id="submissions-container"></div>

    <script>
        // Replace with your actual Google Sheet ID
        const SHEET_ID = '1G10zJSJqOUQ6uIzDw87mP48a5ZlhiaQvg_6w-Q1SwnY';
        const SHEET_NAME = 'Form Responses 1'; // This is typically the default name for form responses
        
        // Global variables
        let allSubmissions = [];
        let activeSettingFilters = [];
        let activeCharacterFilters = [];
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            fetchSubmissions();
            
            // Set up search functionality
            document.getElementById('search').addEventListener('input', function() {
                filterSubmissions();
            });
        });
        
        // Fetch submissions from Google Sheets
        function fetchSubmissions() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
            
            document.getElementById('loading').textContent = 'Connecting to Google Sheets...';
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    document.getElementById('loading').textContent = 'Parsing data...';
                    return response.text();
                })
                .then(data => {
                    // Log the first bit of response for debugging
                    console.log("Raw response starts with:", data.substring(0, 100));
                    
                    // Google's response comes wrapped in a prefix we need to remove
                    // The format is usually: "/*O_o*/google.visualization.Query.setResponse({...});"
                    const jsonStart = data.indexOf('{');
                    const jsonEnd = data.lastIndexOf('}');
                    
                    if (jsonStart === -1 || jsonEnd === -1) {
                        // If we can't find valid JSON, show the user and display in the console
                        console.error("Couldn't parse Google Sheets response. Raw data:", data);
                        throw new Error("Invalid data format from Google Sheets. Is the sheet published to the web?");
                    }
                    
                    const jsonString = data.substring(jsonStart, jsonEnd + 1);
                    console.log("Extracted JSON starts with:", jsonString.substring(0, 100));
                    
                    const jsonData = JSON.parse(jsonString);
                    
                    // Process the data
                    document.getElementById('loading').textContent = 'Processing submissions...';
                    allSubmissions = processGoogleSheetsData(jsonData);
                    
                    console.log(`Found ${allSubmissions.length} valid submissions`);
                    
                    if (allSubmissions.length === 0) {
                        document.getElementById('loading').textContent = 'No submissions found. Check console for details.';
                        return;
                    }
                    
                    // Generate filters
                    generateSettingFilters();
                    generateCharacterFilters();
                    
                    // Display all submissions
                    document.getElementById('loading').style.display = 'none';
                    displaySubmissions(allSubmissions);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('loading').innerHTML = `
                        <p>Error loading submissions: ${error.message}</p>
                        <p>Please make sure your Google Sheet is published to the web.</p>
                        <p>See browser console for technical details (press F12 to open).</p>
                    `;
                });
        }
        
        // Process the Google Sheets data into our format
        function processGoogleSheetsData(jsonData) {
            const submissions = [];
            const rows = jsonData.table.rows;
            const cols = jsonData.table.cols;
            
            // Add debugging - show column headers in console
            console.log("Column headers:", cols.map(col => col.label));
            
            // Map column headers to indices - more flexible with sanitization
            const headerMap = {};
            cols.forEach((col, index) => {
                // Sanitize header names for more consistent matching
                if (col.label) {
                    const label = col.label.toLowerCase().trim();
                    headerMap[label] = index;
                    
                    // Add common variations for more robust matching
                    if (label.includes('user')) headerMap['username'] = index;
                    if (label.includes('author')) headerMap['author'] = index;
                    if (label.includes('character')) headerMap['characters'] = index;
                    if (label.includes('setting')) headerMap['setting'] = index;
                    if (label.includes('submission')) headerMap['submission'] = index;
                    if (label.includes('text')) headerMap['submissiontext'] = index;
                    if (label.includes('read more')) headerMap['links'] = index;
                }
            });
            
            console.log("Header mapping:", headerMap);
            
            // Show total rows for debugging
            console.log(`Processing ${rows.length} rows of data`);
            
            // Process each row (including the first row in case it's not a header)
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i].c;
                
                // Skip empty rows
                if (!row || !row[0]) {
                    console.log(`Skipping row ${i}: Empty`);
                    continue;
                }
                
                try {
                    // Try to extract required fields (username and submission text are essential)
                    const username = row[headerMap['username']]?.v || 'Anonymous';
                    const submissionText = row[headerMap['submission'] || headerMap['submissiontext']]?.v || '';
                    
                    // Skip if no submission text (likely a header row or empty submission)
                    if (!submissionText) {
                        console.log(`Skipping row ${i}: No submission text`);
                        continue;
                    }
                    
                    // Create submission object with fallbacks for all fields
                    const submission = {
                        timestamp: row[0]?.v || '', // First column is usually timestamp
                        username: username,
                        authorName: row[headerMap['author'] || headerMap['author name']]?.v || '',
                        links: row[headerMap['links']]?.v || '',
                        characters: parseList(row[headerMap['characters']]?.v || ''),
                        setting: parseList(row[headerMap['setting']]?.v || ''),
                        submissionText: submissionText
                    };
                    
                    // If we're missing critical fields, try direct indices as a fallback
                    if (!submission.username && row[1]) submission.username = row[1].v || 'Anonymous';
                    if (!submission.submissionText && row[6]) submission.submissionText = row[6].v || 'No content provided';
                    
                    // One last check to make sure we have content
                    if (submission.submissionText && submission.submissionText !== 'No content provided') {
                        submissions.push(submission);
                        console.log(`Added submission from: ${submission.username}`);
                    } else {
                        console.log(`Skipping row ${i}: Invalid submission data`);
                    }
                } catch (error) {
                    console.error(`Error processing row ${i}:`, error);
                }
            }
            
            return submissions;
        }
        
        // Parse comma or newline separated lists
        function parseList(text) {
            if (!text) return [];
            
            // Split by commas or newlines and trim each item
            return text
                .split(/[,\n]/)
                .map(item => item.trim())
                .filter(item => item);
        }
        
        // Generate setting filter tags
        function generateSettingFilters() {
            const allSettings = new Set();
            
            // Collect all unique settings
            allSubmissions.forEach(sub => {
                sub.setting.forEach(setting => allSettings.add(setting));
            });
            
            // Create filter tags
            const filterContainer = document.getElementById('setting-filters');
            
            allSettings.forEach(setting => {
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.textContent = setting;
                tag.addEventListener('click', function() {
                    toggleSettingFilter(setting, tag);
                });
                filterContainer.appendChild(tag);
            });
        }
        
        // Generate character filter tags
        function generateCharacterFilters() {
            const allCharacters = new Set();
            
            // Collect all unique characters
            allSubmissions.forEach(sub => {
                sub.characters.forEach(char => allCharacters.add(char));
            });
            
            // Create filter tags
            const filterContainer = document.getElementById('character-filters');
            
            allCharacters.forEach(character => {
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.textContent = character;
                tag.addEventListener('click', function() {
                    toggleCharacterFilter(character, tag);
                });
                filterContainer.appendChild(tag);
            });
        }
        
        // Toggle setting filter
        function toggleSettingFilter(setting, tagElement) {
            const index = activeSettingFilters.indexOf(setting);
            
            if (index === -1) {
                // Add the filter
                activeSettingFilters.push(setting);
                tagElement.classList.add('active');
            } else {
                // Remove the filter
                activeSettingFilters.splice(index, 1);
                tagElement.classList.remove('active');
            }
            
            filterSubmissions();
        }
        
        // Toggle character filter
        function toggleCharacterFilter(character, tagElement) {
            const index = activeCharacterFilters.indexOf(character);
            
            if (index === -1) {
                // Add the filter
                activeCharacterFilters.push(character);
                tagElement.classList.add('active');
            } else {
                // Remove the filter
                activeCharacterFilters.splice(index, 1);
                tagElement.classList.remove('active');
            }
            
            filterSubmissions();
        }
        
        // Filter submissions based on search and filters
        function filterSubmissions() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            
            const filtered = allSubmissions.filter(sub => {
                // Search term filtering
                const matchesSearch = 
                    sub.username.toLowerCase().includes(searchTerm) || 
                    sub.authorName.toLowerCase().includes(searchTerm) || 
                    sub.characters.some(char => char.toLowerCase().includes(searchTerm)) ||
                    sub.setting.some(setting => setting.toLowerCase().includes(searchTerm)) ||
                    sub.submissionText.toLowerCase().includes(searchTerm);
                
                // Character filtering
                const matchesCharacters = 
                    activeCharacterFilters.length === 0 || 
                    activeCharacterFilters.some(char => sub.characters.includes(char));
                
                // Setting filtering
                const matchesSettings = 
                    activeSettingFilters.length === 0 || 
                    activeSettingFilters.some(setting => sub.setting.includes(setting));
                
                return matchesSearch && matchesCharacters && matchesSettings;
            });
            
            displaySubmissions(filtered);
        }
        
        // Display submissions on the page
        function displaySubmissions(subs) {
            const container = document.getElementById('submissions-container');
            container.innerHTML = '';
            
            if (subs.length === 0) {
                container.innerHTML = '<p>No submissions found matching your search.</p>';
                return;
            }
            
            subs.forEach(sub => {
                const submissionDiv = document.createElement('div');
                submissionDiv.className = 'submission';
                
                // Create tags for characters and settings
                const characterTags = sub.characters.map(char => 
                    `<span class="tag character-tag">${char}</span>`
                ).join('');
                
                const settingTags = sub.setting.map(setting => 
                    `<span class="tag setting-tag">${setting}</span>`
                ).join('');
                
                // Format links if they exist
                let linksHTML = '';
                if (sub.links && sub.links.trim()) {
                    linksHTML = `
                        <div class="links">
                            <span class="meta-label">More from this author:</span> 
                            <a href="${sub.links}" target="_blank">${sub.links}</a>
                        </div>
                    `;
                }
                
                // Format author display name
                const authorDisplay = sub.authorName ? sub.authorName : sub.username;
                
                submissionDiv.innerHTML = `
                    <h2>${sub.username}'s Submission</h2>
                    <div class="meta">
                        <div class="meta-group">
                            <div><span class="meta-label">Author:</span> ${authorDisplay}</div>
                            ${linksHTML}
                        </div>
                        
                        <div class="meta-group">
                            <div><span class="meta-label">Setting:</span></div>
                            <div>${settingTags || 'Not specified'}</div>
                        </div>
                        
                        <div class="meta-group">
                            <div><span class="meta-label">Characters:</span></div>
                            <div>${characterTags || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div class="content">${formatContent(sub.submissionText)}</div>
                `;
                
                container.appendChild(submissionDiv);
            });
        }
        
        // Format content with basic HTML handling
        function formatContent(text) {
            if (!text) return '';
            
            // Replace line breaks with paragraph tags
            return text.replace(/\n\n/g, '</p><p>')
                       .replace(/\n/g, '<br>')
                       .replace(/^(.+)/, '<p>$1')
                       .replace(/(.+)$/, '$1</p>');
        }
    </script>
</body>
</html>
